# Arquitectura del Sistema S3-Snowflake-KMS

## ğŸ“Š Diagrama de Flujo de Datos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SNOWFLAKE ACCOUNT                            â”‚
â”‚                     (RAGRCLW-SN28326)                               â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Database   â”‚â”€â”€â”€â†’â”‚   Schema    â”‚â”€â”€â”€â†’â”‚    Stage     â”‚          â”‚
â”‚  â”‚ DEMO_KMS_V3  â”‚    â”‚DEMO_SCHEMA  â”‚    â”‚S3_STAGE_KMS  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                  â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚    Storage Integration                    â”‚  â”‚                  â”‚
â”‚  â”‚    S3_INTEGRATION_KMS                     â”‚  â”‚                  â”‚
â”‚  â”‚    â”œâ”€ Type: EXTERNAL_STAGE               â”‚  â”‚                  â”‚
â”‚  â”‚    â”œâ”€ Provider: S3                        â”‚â—€â”€â”˜                  â”‚
â”‚  â”‚    â””â”€ Encryption: Handled by S3/KMS      â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Assume Role (sts:AssumeRole)
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AWS ACCOUNT                                â”‚
â”‚                       (997439898896)                                â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              IAM ROLE: snowflake-s3-kms-role              â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  Trust Policy:                                             â”‚    â”‚
â”‚  â”‚  â”œâ”€ Principal: Snowflake IAM User                         â”‚    â”‚
â”‚  â”‚  â”‚   arn:aws:iam::260512157176:user/5c391000-s           â”‚    â”‚
â”‚  â”‚  â””â”€ Condition: ExternalId = ZR06009_SFCRole=5_Frad...     â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  Permissions:                                              â”‚    â”‚
â”‚  â”‚  â”œâ”€ S3: GetObject, PutObject, ListBucket, etc.           â”‚    â”‚
â”‚  â”‚  â””â”€ KMS: Decrypt, Encrypt, GenerateDataKey               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â”‚                  â”‚                     â”‚
â”‚                           â†“                  â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      S3 Bucket              â”‚  â”‚      KMS Key             â”‚   â”‚
â”‚  â”‚  s3-snow-kms-test-v3        â”‚  â”‚  snowflake-s3-kms-key    â”‚   â”‚
â”‚  â”‚                             â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚  Configuration:             â”‚  â”‚  Configuration:          â”‚   â”‚
â”‚  â”‚  â”œâ”€ Encryption: SSE-KMS  â”€â”€â”€â”¼â”€â†’â”‚  â”œâ”€ Rotation: Enabled   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Key: aws:kms            â”‚  â”‚  â”œâ”€ Deletion: 10 days   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Bucket Key: Enabled     â”‚  â”‚  â””â”€ Alias:              â”‚   â”‚
â”‚  â”‚  â”œâ”€ Versioning: Enabled     â”‚  â”‚    /snowflake-s3-kms    â”‚   â”‚
â”‚  â”‚  â”œâ”€ Public Access: Blocked  â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚  â””â”€ Lifecycle Rules: Active â”‚  â”‚  Permissions:            â”‚   â”‚
â”‚  â”‚                             â”‚  â”‚  â”œâ”€ Root: Full Access    â”‚   â”‚
â”‚  â”‚  Folders:                   â”‚  â”‚  â”œâ”€ S3: Encrypt/Decrypt  â”‚   â”‚
â”‚  â”‚  â””â”€ snowflake-data/         â”‚  â”‚  â”œâ”€ IAM Role: Use key    â”‚   â”‚
â”‚  â”‚     â”œâ”€ *.csv                â”‚  â”‚  â””â”€ Snowflake: Decrypt   â”‚   â”‚
â”‚  â”‚     â”œâ”€ *.parquet            â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚     â””â”€ *.json               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flujo de Operaciones

### 1. Carga de Datos (COPY INTO)

```
[Snowflake] â”€â”€(1)â”€â”€> [IAM Role] â”€â”€(2)â”€â”€> [S3 Bucket]
                         â”‚                    â”‚
                         â””â”€â”€(3)â”€â”€> [KMS] â—€â”€â”€(4)â”€â”˜
                                     â”‚
                                   (5)â”€â”€> Descifra datos
                                     â”‚
                         â”Œâ”€â”€(6)â—€â”€â”€â”€â”€â”˜
                         â†“
                    [Snowflake]
                  (Datos cargados)
```

**Pasos:**
1. Snowflake asume el IAM role con External ID
2. IAM role solicita acceso a S3
3. IAM role solicita permiso para descifrar con KMS
4. S3 solicita clave de descifrado a KMS
5. KMS verifica permisos y descifra
6. Datos fluyen a Snowflake

### 2. Escritura de Datos (COPY FROM)

```
[Snowflake] â”€â”€(1)â”€â”€> [IAM Role] â”€â”€(2)â”€â”€> [S3 Bucket]
                         â”‚                    â”‚
                         â””â”€â”€(3)â”€â”€> [KMS]     â”‚
                                     â”‚        â”‚
                         â”Œâ”€â”€(4)â—€â”€â”€â”€â”€â”˜        â”‚
                         â”‚                   â”‚
                         â””â”€â”€(5)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
                                   (Datos cifrados se guardan en S3)
```

**Pasos:**
1. Snowflake asume el IAM role
2. IAM role solicita escribir en S3
3. IAM role solicita clave de cifrado a KMS
4. KMS genera data key y la devuelve
5. Datos se cifran con data key y se guardan en S3

## ğŸ” Capas de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capa 1: AUTENTICACIÃ“N                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ Snowflake Storage Integration                             â”‚â”‚
â”‚ â”‚ âœ“ IAM Role Assumption con External ID                        â”‚â”‚
â”‚ â”‚ âœ“ Trust Policy especÃ­fica                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capa 2: AUTORIZACIÃ“N                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ IAM Policies (S3 + KMS permisos mÃ­nimos)                  â”‚â”‚
â”‚ â”‚ âœ“ S3 Bucket Policy                                           â”‚â”‚
â”‚ â”‚ âœ“ KMS Key Policy                                             â”‚â”‚
â”‚ â”‚ âœ“ Condition Keys (kms:ViaService)                            â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capa 3: ENCRIPTACIÃ“N                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ AWS KMS Key (rotaciÃ³n automÃ¡tica)                         â”‚â”‚
â”‚ â”‚ âœ“ SSE-KMS en S3                                              â”‚â”‚
â”‚ â”‚ âœ“ S3 Bucket Key (reduce API calls)                          â”‚â”‚
â”‚ â”‚ âœ“ Datos cifrados en reposo                                  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capa 4: AUDITORÃA                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ CloudTrail (KMS + S3 API calls)                           â”‚â”‚
â”‚ â”‚ âœ“ S3 Access Logs                                             â”‚â”‚
â”‚ â”‚ âœ“ Snowflake Query History                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capa 5: PROTECCIÃ“N DE DATOS                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ S3 Versioning                                              â”‚â”‚
â”‚ â”‚ âœ“ S3 Lifecycle Rules                                         â”‚â”‚
â”‚ â”‚ âœ“ Public Access Block                                        â”‚â”‚
â”‚ â”‚ âœ“ KMS Deletion Window (10 dÃ­as)                             â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° Modelo de Costos

### Sin S3 Bucket Key:
```
Cada objeto escrito/leÃ­do = 1 KMS API call

Ejemplo: 1,000,000 objetos/mes
â”œâ”€ KMS Requests: 1,000,000 Ã— $0.03/10,000 = $3,000/mes
â”œâ”€ KMS Key Storage: $1/mes
â””â”€ Total KMS: $3,001/mes âŒ MUY CARO
```

### Con S3 Bucket Key (Implementado):
```
Bucket hace batch de requests a KMS

Ejemplo: 1,000,000 objetos/mes
â”œâ”€ KMS Requests: ~1,000 Ã— $0.03/10,000 = ~$0.30/mes
â”œâ”€ KMS Key Storage: $1/mes
â””â”€ Total KMS: ~$1.30/mes âœ… ECONÃ“MICO (99% ahorro)
```

## ğŸ“ˆ Recursos Creados

```yaml
AWS Resources:
  KMS:
    - Key: 1 (con rotaciÃ³n automÃ¡tica)
    - Alias: 1
    - Policy: 1 (dinÃ¡mica)
  
  S3:
    - Bucket: 1
    - Encryption Config: 1 (SSE-KMS + Bucket Key)
    - Versioning: Enabled
    - Public Access Block: Full
    - Bucket Policy: 1
    - Lifecycle Rules: 2
  
  IAM:
    - Role: 1
    - Trust Policy: 1 (dinÃ¡mica)
    - Inline Policy: 1 (S3 + KMS)

Snowflake Resources:
  - Database: 1
  - Schema: 1
  - Storage Integration: 1
  - External Stage: 1
  - Grants: 3 (database, schema, integration)
```

## ğŸ”— Dependencias entre Recursos

```
main.tf
   â†“
providers.tf
   â†“
variables.tf
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Fase 1: Base Resources         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ KMS Key â”‚â†â”€â”€â”€â”€â”€â”€â”‚ KMS Aliasâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚                                â”‚
â”‚       â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚ S3 Bucketâ”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                 â”‚                      â”‚
â”‚                 â”œâ†’ Encryption Config   â”‚
â”‚                 â”œâ†’ Versioning          â”‚
â”‚                 â”œâ†’ Public Block        â”‚
â”‚                 â””â†’ Lifecycle Rules     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Fase 2: IAM & Integration        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ IAM Role â”‚ (trust policy temporal)  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚       â”‚                                â”‚
â”‚       â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚            â”‚ Snowflake Database    â”‚  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                   â”‚
â”‚                    â”œâ†’ Schema           â”‚
â”‚                    â”‚                   â”‚
â”‚                    â””â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                       â”‚Storage Int   â”‚â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Fase 3: Final Updates          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Update IAM Trust    â”‚               â”‚
â”‚  â”‚ Policy with         â”‚               â”‚
â”‚  â”‚ Snowflake IAM User  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚            â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Update KMS Policy   â”‚               â”‚
â”‚  â”‚ with Snowflake      â”‚               â”‚
â”‚  â”‚ IAM User            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚            â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Create Stage        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
            outputs.tf
```

## ğŸ¯ Puntos Clave de la Arquitectura

1. **EncriptaciÃ³n End-to-End**: Datos siempre cifrados en S3
2. **Zero Trust**: Multiple capas de autenticaciÃ³n y autorizaciÃ³n
3. **Cost Optimized**: Bucket Key reduce costos de KMS en 99%
4. **Auto-Managed**: KMS rotation automÃ¡tica cada aÃ±o
5. **Auditable**: Todos los accesos registrados
6. **Resilient**: Versioning protege contra eliminaciÃ³n accidental
7. **Scalable**: Lifecycle rules gestionan datos antiguos automÃ¡ticamente

## ğŸ“š Referencias de ConfiguraciÃ³n

### KMS Key Configuration
```hcl
- Deletion Window: 10 dÃ­as
- Key Rotation: Enabled (automÃ¡tica anual)
- Key Policy: DinÃ¡mica (se actualiza con Snowflake IAM User)
- Alias: alias/snowflake-s3-kms-stage
```

### S3 Bucket Configuration
```hcl
- Encryption: aws:kms
- Bucket Key: Enabled
- Versioning: Enabled
- Public Access: Blocked (all)
- Lifecycle: 
  - Non-current versions: Delete after 90 days
  - Transition to IA: After 30 days
  - Transition to Glacier: After 90 days
```

### IAM Role Configuration
```hcl
- Trust Policy: Snowflake IAM User + External ID
- S3 Permissions: GetObject, PutObject, ListBucket
- KMS Permissions: Decrypt, Encrypt, GenerateDataKey
- Condition: kms:ViaService = s3.eu-west-1.amazonaws.com
```

---

**Ãšltima actualizaciÃ³n**: Noviembre 2025
