# S3-Snowflake-KMS System Architecture

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SNOWFLAKE ACCOUNT                            â”‚
â”‚                     (RAGRCLW-SN28326)                               â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Database   â”‚â”€â”€â”€â†’â”‚   Schema    â”‚â”€â”€â”€â†’â”‚    Stage     â”‚          â”‚
â”‚  â”‚ DEMO_KMS_V3  â”‚    â”‚DEMO_SCHEMA  â”‚    â”‚S3_STAGE_KMS  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                  â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚
â”‚  â”‚    Storage Integration                    â”‚  â”‚                  â”‚
â”‚  â”‚    S3_INTEGRATION_KMS                     â”‚  â”‚                  â”‚
â”‚  â”‚    â”œâ”€ Type: EXTERNAL_STAGE               â”‚  â”‚                  â”‚
â”‚  â”‚    â”œâ”€ Provider: S3                        â”‚â—€â”€â”˜                  â”‚
â”‚  â”‚    â””â”€ Encryption: Handled by S3/KMS      â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ Assume Role (sts:AssumeRole)
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AWS ACCOUNT                                â”‚
â”‚                       (997439898896)                                â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              IAM ROLE: snowflake-s3-kms-role              â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  Trust Policy:                                             â”‚    â”‚
â”‚  â”‚  â”œâ”€ Principal: Snowflake IAM User                         â”‚    â”‚
â”‚  â”‚  â”‚   arn:aws:iam::260512157176:user/5c391000-s           â”‚    â”‚
â”‚  â”‚  â””â”€ Condition: ExternalId = ZR06009_SFCRole=5_Frad...     â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚  Permissions:                                              â”‚    â”‚
â”‚  â”‚  â”œâ”€ S3: GetObject, PutObject, ListBucket, etc.           â”‚    â”‚
â”‚  â”‚  â””â”€ KMS: Decrypt, Encrypt, GenerateDataKey               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                           â”‚                  â”‚                     â”‚
â”‚                           â†“                  â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      S3 Bucket              â”‚  â”‚      KMS Key             â”‚   â”‚
â”‚  â”‚  s3-snow-kms-test-v3        â”‚  â”‚  snowflake-s3-kms-key    â”‚   â”‚
â”‚  â”‚                             â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚  Configuration:             â”‚  â”‚  Configuration:          â”‚   â”‚
â”‚  â”‚  â”œâ”€ Encryption: SSE-KMS  â”€â”€â”€â”¼â”€â†’â”‚  â”œâ”€ Rotation: Enabled   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Key: aws:kms            â”‚  â”‚  â”œâ”€ Deletion: 10 days   â”‚   â”‚
â”‚  â”‚  â”œâ”€ Bucket Key: Enabled     â”‚  â”‚  â””â”€ Alias:              â”‚   â”‚
â”‚  â”‚  â”œâ”€ Versioning: Enabled     â”‚  â”‚    /snowflake-s3-kms    â”‚   â”‚
â”‚  â”‚  â”œâ”€ Public Access: Blocked  â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚  â””â”€ Lifecycle Rules: Active â”‚  â”‚  Permissions:            â”‚   â”‚
â”‚  â”‚                             â”‚  â”‚  â”œâ”€ Root: Full Access    â”‚   â”‚
â”‚  â”‚  Folders:                   â”‚  â”‚  â”œâ”€ S3: Encrypt/Decrypt  â”‚   â”‚
â”‚  â”‚  â””â”€ snowflake-data/         â”‚  â”‚  â”œâ”€ IAM Role: Use key    â”‚   â”‚
â”‚  â”‚     â”œâ”€ *.csv                â”‚  â”‚  â””â”€ Snowflake: Decrypt   â”‚   â”‚
â”‚  â”‚     â”œâ”€ *.parquet            â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚     â””â”€ *.json               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Operations Flow

### 1. Data Loading (COPY INTO)

```
[Snowflake] â”€â”€(1)â”€â”€> [IAM Role] â”€â”€(2)â”€â”€> [S3 Bucket]
                         â”‚                    â”‚
                         â””â”€â”€(3)â”€â”€> [KMS] â—€â”€â”€(4)â”€â”˜
                                     â”‚
                                   (5)â”€â”€> Decrypt data
                                     â”‚
                         â”Œâ”€â”€(6)â—€â”€â”€â”€â”€â”˜
                         â†“
                    [Snowflake]
                  (Data loaded)
```

**Steps:**
1. Snowflake assumes IAM role with External ID
2. IAM role requests S3 access
3. IAM role requests permission to decrypt with KMS
4. S3 requests decryption key from KMS
5. KMS verifies permissions and decrypts
6. Data flows to Snowflake

### 2. Data Writing (COPY FROM)

```
[Snowflake] â”€â”€(1)â”€â”€> [IAM Role] â”€â”€(2)â”€â”€> [S3 Bucket]
                         â”‚                    â”‚
                         â””â”€â”€(3)â”€â”€> [KMS]     â”‚
                                     â”‚        â”‚
                         â”Œâ”€â”€(4)â—€â”€â”€â”€â”€â”˜        â”‚
                         â”‚                   â”‚
                         â””â”€â”€(5)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
**Steps:**
1. Snowflake assumes IAM role
2. IAM role requests to write to S3
3. IAM role requests encryption key from KMS
4. KMS generates data key and returns it
5. Data is encrypted with data key and saved to S3

## ğŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: AUTHENTICATION                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ Snowflake Storage Integration                             â”‚â”‚
â”‚ â”‚ âœ“ IAM Role Assumption with External ID                       â”‚â”‚
â”‚ â”‚ âœ“ Specific Trust Policy                                      â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: AUTHORIZATION                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ IAM Policies (S3 + KMS minimum permissions)               â”‚â”‚
â”‚ â”‚ âœ“ S3 Bucket Policy                                           â”‚â”‚
â”‚ â”‚ âœ“ KMS Key Policy                                             â”‚â”‚
â”‚ â”‚ âœ“ Condition Keys (kms:ViaService)                            â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: ENCRYPTION                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ AWS KMS Key (automatic rotation)                          â”‚â”‚
â”‚ â”‚ âœ“ SSE-KMS on S3                                              â”‚â”‚
â”‚ â”‚ âœ“ S3 Bucket Key (reduces API calls)                         â”‚â”‚
â”‚ â”‚ âœ“ Data encrypted at rest                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 4: AUDITING                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ CloudTrail (KMS + S3 API calls)                           â”‚â”‚
â”‚ â”‚ âœ“ S3 Access Logs                                             â”‚â”‚
â”‚ â”‚ âœ“ Snowflake Query History                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 5: DATA PROTECTION                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ âœ“ S3 Versioning                                              â”‚â”‚
â”‚ â”‚ âœ“ S3 Lifecycle Rules                                         â”‚â”‚
â”‚ â”‚ âœ“ Public Access Block                                        â”‚â”‚
â”‚ â”‚ âœ“ KMS Deletion Window (10 days)                             â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° Cost Model

### Without S3 Bucket Key:
```
Each object written/read = 1 KMS API call

Example: 1,000,000 objects/month
â”œâ”€ KMS Requests: 1,000,000 Ã— $0.03/10,000 = $3,000/month
â”œâ”€ KMS Key Storage: $1/month
â””â”€ Total KMS: $3,001/month âŒ VERY EXPENSIVE
```

### With S3 Bucket Key (Implemented):
```
Bucket batches requests to KMS

Example: 1,000,000 objects/month
â”œâ”€ KMS Requests: ~1,000 Ã— $0.03/10,000 = ~$0.30/month
â”œâ”€ KMS Key Storage: $1/month
â””â”€ Total KMS: ~$1.30/month âœ… ECONOMICAL (99% savings)
```

## ğŸ“ˆ Resources Created

```yaml
AWS Resources:
  KMS:
    - Key: 1 (with automatic rotation)
    - Alias: 1
    - Policy: 1 (dynamic)
  
  S3:
    - Bucket: 1
    - Encryption Config: 1 (SSE-KMS + Bucket Key)
    - Versioning: Enabled
    - Public Access Block: Full
    - Bucket Policy: 1
    - Lifecycle Rules: 2
  
  IAM:
    - Role: 1
    - Trust Policy: 1 (dynamic)
    - Inline Policy: 1 (S3 + KMS)

Snowflake Resources:
  - Database: 1
  - Schema: 1
  - Storage Integration: 1
  - External Stage: 1
  - Grants: 3 (database, schema, integration)
```

## ğŸ”— Resource Dependencies

```
main.tf
   â†“
providers.tf
   â†“
variables.tf
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Phase 1: Base Resources         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ KMS Key â”‚â†â”€â”€â”€â”€â”€â”€â”‚ KMS Aliasâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚                                â”‚
â”‚       â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚            â”‚ S3 Bucketâ”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                 â”‚                      â”‚
â”‚                 â”œâ†’ Encryption Config   â”‚
â”‚                 â”œâ†’ Versioning          â”‚
â”‚                 â”œâ†’ Public Block        â”‚
â”‚                 â””â†’ Lifecycle Rules     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Phase 2: IAM & Integration        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ IAM Role â”‚ (temporary trust policy) â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚       â”‚                                â”‚
â”‚       â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚            â”‚ Snowflake Database    â”‚  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â”‚                   â”‚
â”‚                    â”œâ†’ Schema           â”‚
â”‚                    â”‚                   â”‚
â”‚                    â””â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                       â”‚Storage Int   â”‚â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Phase 3: Final Updates          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Update IAM Trust    â”‚               â”‚
â”‚  â”‚ Policy with         â”‚               â”‚
â”‚  â”‚ Snowflake IAM User  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚            â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Update KMS Policy   â”‚               â”‚
â”‚  â”‚ with Snowflake      â”‚               â”‚
â”‚  â”‚ IAM User            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚            â†“                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Create Stage        â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
            outputs.tf
```

## ğŸ¯ Key Architecture Points

1. **End-to-End Encryption**: Data always encrypted in S3
2. **Zero Trust**: Multiple layers of authentication and authorization
3. **Cost Optimized**: Bucket Key reduces KMS costs by 99%
4. **Auto-Managed**: Automatic KMS rotation every year
5. **Auditable**: All accesses logged
6. **Resilient**: Versioning protects against accidental deletion
7. **Scalable**: Lifecycle rules manage old data automatically

## ğŸ“š Configuration References

### KMS Key Configuration
```hcl
- Deletion Window: 10 days
- Key Rotation: Enabled (automatic annually)
- Key Policy: Dynamic (updated with Snowflake IAM User)
- Alias: alias/snowflake-s3-kms-stage
```

### S3 Bucket Configuration
```hcl
- Encryption: aws:kms
- Bucket Key: Enabled
- Versioning: Enabled
- Public Access: Blocked (all)
- Lifecycle: 
  - Non-current versions: Delete after 90 days
  - Transition to IA: After 30 days
  - Transition to Glacier: After 90 days
```

### IAM Role Configuration
```hcl
- Trust Policy: Snowflake IAM User + External ID
- S3 Permissions: GetObject, PutObject, ListBucket
- KMS Permissions: Decrypt, Encrypt, GenerateDataKey
- Condition: kms:ViaService = s3.eu-west-1.amazonaws.com
```

---

**Last updated**: November 2025
